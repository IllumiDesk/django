{% load static %}

<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
  </head>
  <body>
    <form action="{{ action_url}}" id="fileForm" name="fileForm" method="post">
      <input type="hidden" value="ContentItemSelection" name="lti_message_type" />
      <input type="hidden" value="{{ lti_version }}" name="lti_version" />
      <h2>Select notebook file:</h2>
      <ul>{% for project in projects %}
        <li class="project">
          <a href="#" class="directory">
            {{ project.name }}
            <i class="arrow-down"{% if not forloop.first %} style="display: none;"{% endif %}>↓</i>
            <i class="arrow-right"{% if forloop.first %} style="display: none;"{% endif %}>→</i>
          </a>
          <ul{% if not forloop.first %} style="display: none;"{% endif %}>{% for file in project.files %}
            <li>
              <label>
                  <input type="radio" id="url" value="{{ file.content_items|escape }}" data-path="{{ file.path }}" data-project="{{ file.project }}" name="content_items" required />
                {{ file.path }}
              </label>
            </li>
          {% endfor %}</ul>
        </li>
        {% endfor %}</ul>
      <button type="submit">Accept</button>
    </form>
  <script type="text/javascript">
    (function() {
      document.querySelectorAll('.directory').forEach(function(item) {
        item.onclick = function (e) {
          var fileList = e.target.closest('.project').querySelector('ul'),
              arrowDown = e.target.parentElement.querySelector('.arrow-down'),
              arrowRight = e.target.parentElement.querySelector('.arrow-right');
          if (fileList.style.display === "none") {
            fileList.style.display = "block";
            arrowDown.style.display = "inline";
            arrowRight.style.display = "none";
          } else {
            fileList.style.display = "none";
            arrowDown.style.display = "none";
            arrowRight.style.display = "inline";
          }
        }
      });
      var form = document.getElementById("fileForm");
      form.onsubmit = submit;
      function submit(e) {
        e.preventDefault();
        var input = document.querySelector('input[name="content_items"]:checked');
        var path = input.getAttribute("data-path");
        var project = input.getAttribute("data-project");
        var url = `${window.location.origin}/{{ version }}/{{ namespace }}/projects/${project}/assignments/`
        fetch(url, {
            method: 'post',
            body: JSON.stringify({
                external_id: '{{ assignment_id }}',
                path: path,
                lms_instance: '{{ canvas_instance_id }}',
                oauth_app: '{{ oauth_app }}',
                teacher_project: project,
                course_id: '{{ course_id }}',
            }),
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'JWT {{ token }}',
            },
        }).then(() => form.submit()).catch(err => alert(`There was an error selecting assignment:\n ${err}`));
      }
    }());
  </script>
  </body>
</html>